<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grand Monarch — Underwriting Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- Babel for JSX-in-browser (ok for a single-file HTML) -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Recharts UMD -->
  <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo, useRef } = React;
    const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend } = Recharts;

    // ---------- Helpers ----------
    const num = (n, d = 0) => {
      if (n === null || n === undefined) return d;
      const x = typeof n === 'string' ? n.replace(/[$,%\s,]/g, '') : n;
      const v = Number(x);
      return Number.isFinite(v) ? v : d;
    };

    const currency = (n) => new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(n || 0);

    function scoreDeal({ capRate, targetCap, dscr, equityMultiple }) {
      let score = 0;
      if (capRate >= targetCap) score += 1; else if (capRate >= targetCap * 0.9) score += 0.5;
      if (dscr >= 1.25) score += 1; else if (dscr >= 1.15) score += 0.5;
      if (equityMultiple >= 2.0) score += 1; else if (equityMultiple >= 1.7) score += 0.5;
      if (score >= 2.5) return { label: 'GOOD', color: 'bg-emerald-500' };
      if (score >= 1.5) return { label: 'BORDERLINE', color: 'bg-amber-500' };
      return { label: 'BAD', color: 'bg-rose-500' };
    }

    function Tab({ id, label, active, onClick }) {
      return (
        <button onClick={() => onClick(id)} className={`px-3 py-2 text-sm rounded-xl border ${active ? 'bg-white shadow font-medium' : 'bg-gray-100 hover:bg-gray-200'} transition`}>
          {label}
        </button>
      );
    }

    function SectionCard({ title, children, right }) {
      return (
        <div className="bg-white rounded-2xl shadow-sm border p-4">
          <div className="flex items-center justify-between mb-3">
            <div className="font-semibold">{title}</div>
            {right}
          </div>
          {children}
        </div>
      );
    }

    function App() {
      // Prefilled from Synthesis & CoStar comps
      const [purchasePrice, setPurchasePrice] = useState(6000000);
      const [marketCap, setMarketCap] = useState(6.3); // % from CoStar comps
      const [units, setUnits] = useState(72);
      const [monthlyRent, setMonthlyRent] = useState(1319.18 * 72); // total monthly
      const [otherIncomePct, setOtherIncomePct] = useState(0);
      const [opxPerUnit, setOpxPerUnit] = useState(340000 / 72); // override to $340K total
      const [noi, setNoi] = useState(0);

      // Debt
      const [ltv, setLtv] = useState(70); // adjustable 70–90
      const [rate, setRate] = useState(6.75);
      const [amortYears, setAmortYears] = useState(30);
      const [ioYears, setIoYears] = useState(0);

      // Exit
      const [holdYears, setHoldYears] = useState(5);
      const [exitCap, setExitCap] = useState(6.0);
      const [capex, setCapex] = useState(0);
      const [closingCosts, setClosingCosts] = useState(0);
      const [reserves, setReserves] = useState(142549);

      const [tab, setTab] = useState('dashboard');

      // Derived
      const annualDebtService = useMemo(() => {
        if (!purchasePrice) return 0;
        const loan = purchasePrice * (ltv/100);
        const r = rate/100/12;
        const n = amortYears*12;
        const pmt = r === 0 ? loan/n : (loan*r) / (1 - Math.pow(1+r, -n));
        return pmt * 12;
      }, [purchasePrice, ltv, rate, amortYears]);

      const capRate = useMemo(() => purchasePrice ? (noi / purchasePrice) * 100 : 0, [noi, purchasePrice]);
      const dscr = useMemo(() => annualDebtService ? (noi / annualDebtService) : 0, [noi, annualDebtService]);

      const buildNOI = () => {
        const EGI = monthlyRent * 12 * (1 + (otherIncomePct/100));
        const opx = opxPerUnit * units;
        setNoi(Math.max(EGI - opx, 0));
      };

      const equityMultiple = useMemo(() => {
        if (!purchasePrice) return 0;
        const equity = purchasePrice * (1 - ltv/100) + capex + closingCosts + reserves;
        const annualIO = (ioYears>0) ? (purchasePrice * (ltv/100)) * (rate/100) : 0;
        const years = Array.from({ length: holdYears }, (_, i) => i+1);
        let loanBalance = purchasePrice * (ltv/100);
        const r = rate/100/12;
        const n = amortYears*12;
        const monthlyPmt = r === 0 ? loanBalance/(n) : (loanBalance*r)/(1 - Math.pow(1+r, -n));

        let cumDistributions = 0;
        years.forEach((year) => {
          let debtService = 0;
          if (year <= ioYears) {
            debtService = annualIO;
          } else {
            debtService = monthlyPmt * 12;
          }
          const cfy = Math.max(noi - debtService, 0);
          cumDistributions += cfy;
        });

        const terminalValue = noi / (exitCap/100);
        const saleCosts = terminalValue * 0.01;
        let bal = loanBalance;
        if (holdYears > ioYears) {
          const mPaid = (holdYears - ioYears) * 12;
          bal = r === 0 ? Math.max(0, loanBalance - monthlyPmt*mPaid) : loanBalance * Math.pow(1+r, mPaid) - monthlyPmt * ((Math.pow(1+r, mPaid) - 1) / r);
        }

        const netSale = Math.max(terminalValue - saleCosts - bal, 0);
        const totalReturns = cumDistributions + netSale;
        return equity > 0 ? totalReturns / equity : 0;
      }, [purchasePrice, ltv, rate, amortYears, ioYears, holdYears, exitCap, capex, closingCosts, reserves, noi]);

      const verdict = useMemo(() => scoreDeal({ capRate, targetCap: marketCap, dscr, equityMultiple }), [capRate, marketCap, dscr, equityMultiple]);

      // Upload
      const fileRef = useRef(null);
      const handleFile = (file) => {
        const ext = (file.name.split('.').pop() || '').toLowerCase();
        if (ext.includes('csv')) {
          const reader = new FileReader();
          reader.onload = () => {
            const text = String(reader.result);
            const rows = text.split(/\r?\n/).map(r => r.split(','));
            if (!rows.length) return;
            const header = rows[0];
            const idx = header.findIndex(h => /rent/i.test(h));
            const total = rows.slice(1).reduce((acc, row) => acc + num(row[idx], 0), 0);
            setMonthlyRent(total);
          };
          reader.readAsText(file);
        } else if (['xls', 'xlsx'].includes(ext)) {
          const reader = new FileReader();
          reader.onload = () => {
            const wb = XLSX.read(reader.result, { type: 'binary' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(ws, { header: 1 });
            const header = (json[0] || []).map(x => String(x));
            const idx = header.findIndex(h => /rent/i.test(h));
            const total = json.slice(1).reduce((acc, row) => acc + num(row[idx], 0), 0);
            setMonthlyRent(total);
          };
          reader.readAsBinaryString(file);
        }
      };

      // Initial NOI build once on first render so Dashboard isn\'t blank
      React.useEffect(() => { buildNOI(); }, []);

      return (
        <div className="max-w-7xl mx-auto p-6 space-y-6">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-semibold">Grand Monarch — Underwriting</h1>
              <p className="text-sm text-gray-600">Prefilled from Synthesis & CoStar comps (OpEx overridden to $340K). Adjust debt terms to see instant verdict.</p>
            </div>
            <div className={`px-4 py-2 rounded-2xl text-white text-sm shadow ${verdict.color}`}>{verdict.label}</div>
          </div>

          {/* Tabs */}
          <div className="flex flex-wrap gap-2">
            <Tab id="dashboard" label="Dashboard" active={tab==='dashboard'} onClick={setTab} />
            <Tab id="acq" label="Acquisition" active={tab==='acq'} onClick={setTab} />
            <Tab id="unitmix" label="Actual & Unit Mix" active={tab==='unitmix'} onClick={setTab} />
            <Tab id="napkin" label="Napkin" active={tab==='napkin'} onClick={setTab} />
            <Tab id="pl" label="P&L" active={tab==='pl'} onClick={setTab} />
            <Tab id="refi" label="Refi / Exit" active={tab==='refi'} onClick={setTab} />
          </div>

          {/* Dashboard */}
          {tab==='dashboard' && (
            <div className="grid md:grid-cols-3 gap-4">
              <SectionCard title="Cap Rate" right={<div className="text-xs text-gray-500">Target ≥ {marketCap}%</div>}>
                <div className="text-3xl font-semibold">{capRate ? capRate.toFixed(2) + '%' : '–'}</div>
                <div className="mt-3 h-2 bg-gray-200 rounded-full"><div className="h-2 bg-emerald-500 rounded-full" style={{ width: Math.min(100, (capRate/marketCap)*100) + '%' }}></div></div>
              </SectionCard>

              <SectionCard title="DSCR" right={<div className="text-xs text-gray-500">Target ≥ 1.25</div>}>
                <div className="text-3xl font-semibold">{dscr ? dscr.toFixed(2) : '–'}</div>
                <div className="mt-3 h-2 bg-gray-200 rounded-full"><div className="h-2 bg-emerald-500 rounded-full" style={{ width: Math.min(100, (dscr/1.25)*100) + '%' }}></div></div>
              </SectionCard>

              <SectionCard title={`Equity Multiple (Hold ${holdYears}y)`} right={<div className="text-xs text-gray-500">Target ≥ 2.00x</div>}>
                <div className="text-3xl font-semibold">{equityMultiple ? equityMultiple.toFixed(2) + 'x' : '–'}</div>
                <div className="mt-3 h-2 bg-gray-200 rounded-full"><div className="h-2 bg-emerald-500 rounded-full" style={{ width: Math.min(100, (equityMultiple/2)*100) + '%' }}></div></div>
              </SectionCard>

              <SectionCard title="Quick Uploads">
                <div className="space-y-3">
                  <input ref={fileRef} type="file" className="block" onChange={(e)=> e.target.files && handleFile(e.target.files[0])} />
                  <div className="text-sm">Detected monthly rent: <span className="font-semibold">{monthlyRent ? currency(monthlyRent) : '–'}</span></div>
                  <div className="grid grid-cols-3 gap-3">
                    <div>
                      <label className="text-sm">Other Income %</label>
                      <input className="w-full mt-1 border rounded px-2 py-1" type="number" value={otherIncomePct} onChange={e=>setOtherIncomePct(num(e.target.value))} />
                    </div>
                    <div>
                      <label className="text-sm">OpEx / Unit / Yr</label>
                      <input className="w-full mt-1 border rounded px-2 py-1" type="number" value={opxPerUnit} onChange={e=>setOpxPerUnit(num(e.target.value))} />
                    </div>
                    <div className="flex items-end"><button className="w-full py-2 rounded-xl bg-gray-900 text-white" onClick={buildNOI}>Build NOI</button></div>
                  </div>
                </div>
              </SectionCard>

              <SectionCard title="Verdict">
                <div className={`rounded-2xl p-6 text-white ${verdict.color}`}>
                  <div className="text-3xl font-bold">{verdict.label}</div>
                  <div className="opacity-90 mt-2 text-sm">Based on Cap Rate vs Market, DSCR, and Equity Multiple.</div>
                </div>
              </SectionCard>

              <SectionCard title="Deal Sheet (Snapshot)">
                <div className="grid grid-cols-2 gap-y-1 text-sm">
                  <div className="text-gray-600">Price</div><div className="font-medium">{currency(purchasePrice)}</div>
                  <div className="text-gray-600">NOI</div><div className="font-medium">{currency(noi)}</div>
                  <div className="text-gray-600">Cap Rate</div><div className="font-medium">{capRate?capRate.toFixed(2)+'%':'–'}</div>
                  <div className="text-gray-600">DSCR</div><div className="font-medium">{dscr?dscr.toFixed(2):'–'}</div>
                  <div className="text-gray-600">Equity Multiple</div><div className="font-medium">{equityMultiple?equityMultiple.toFixed(2)+'x':'–'}</div>
                </div>
              </SectionCard>
            </div>
          )}

          {/* Acquisition */}
          {tab==='acq' && (
            <div className="grid md:grid-cols-3 gap-4">
              <SectionCard title="Acquisition Inputs">
                <div className="grid gap-3">
                  <label className="text-sm">Purchase Price</label>
                  <input className="border rounded px-2 py-1" type="number" value={purchasePrice} onChange={e=>setPurchasePrice(num(e.target.value))} />

                  <label className="text-sm mt-2">Market Cap Rate Target (%)</label>
                  <input className="border rounded px-2 py-1" type="number" value={marketCap} onChange={e=>setMarketCap(num(e.target.value))} />

                  <label className="text-sm mt-2">NOI (Annual)</label>
                  <input className="border rounded px-2 py-1" type="number" value={noi} onChange={e=>setNoi(num(e.target.value))} />
                </div>
              </SectionCard>

              <SectionCard title="Debt">
                <div className="grid gap-3">
                  <label className="text-sm">LTV (%) — 70 to 90</label>
                  <input className="w-full" type="range" min="70" max="90" step="1" value={ltv} onChange={e=>setLtv(num(e.target.value))} />
                  <div className="text-sm">Current LTV: <span className="font-semibold">{ltv}%</span></div>

                  <label className="text-sm mt-2">Interest Rate (%)</label>
                  <input className="border rounded px-2 py-1" type="number" step="0.01" value={rate} onChange={e=>setRate(num(e.target.value))} />

                  <label className="text-sm mt-2">Amortization (years)</label>
                  <input className="border rounded px-2 py-1" type="number" value={amortYears} onChange={e=>setAmortYears(num(e.target.value))} />

                  <label className="text-sm mt-2">IO Period (years)</label>
                  <input className="border rounded px-2 py-1" type="number" value={ioYears} onChange={e=>setIoYears(num(e.target.value))} />
                </div>
              </SectionCard>

              <SectionCard title="Closing, CapEx & Reserves">
                <div className="grid gap-3">
                  <label className="text-sm">Closing Costs ($)</label>
                  <input className="border rounded px-2 py-1" type="number" value={closingCosts} onChange={e=>setClosingCosts(num(e.target.value))} />

                  <label className="text-sm mt-2">CapEx ($)</label>
                  <input className="border rounded px-2 py-1" type="number" value={capex} onChange={e=>setCapex(num(e.target.value))} />

                  <label className="text-sm mt-2">Reserves ($)</label>
                  <input className="border rounded px-2 py-1" type="number" value={reserves} onChange={e=>setReserves(num(e.target.value))} />

                  <label className="text-sm mt-2">Hold (years)</label>
                  <input className="border rounded px-2 py-1" type="number" value={holdYears} onChange={e=>setHoldYears(num(e.target.value))} />

                  <label className="text-sm mt-2">Exit Cap (%)</label>
                  <input className="border rounded px-2 py-1" type="number" value={exitCap} onChange={e=>setExitCap(num(e.target.value))} />
                </div>
              </SectionCard>
            </div>
          )}

          {/* Unit Mix */}
          {tab==='unitmix' && (
            <div className="grid md:grid-cols-2 gap-4">
              <SectionCard title="Actual & Unit Mix">
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="text-sm">Total Units</label>
                    <input className="w-full mt-1 border rounded px-2 py-1" type="number" value={units} onChange={e=>setUnits(num(e.target.value))} />
                  </div>
                  <div>
                    <label className="text-sm">Monthly Rent (total)</label>
                    <input className="w-full mt-1 border rounded px-2 py-1" type="number" value={monthlyRent} onChange={e=>setMonthlyRent(num(e.target.value))} />
                  </div>
                  <div>
                    <label className="text-sm">Other Income % of Rent</label>
                    <input className="w-full mt-1 border rounded px-2 py-1" type="number" value={otherIncomePct} onChange={e=>setOtherIncomePct(num(e.target.value))} />
                  </div>
                  <div>
                    <label className="text-sm">OpEx / Unit / Yr</label>
                    <input className="w-full mt-1 border rounded px-2 py-1" type="number" value={opxPerUnit} onChange={e=>setOpxPerUnit(num(e.target.value))} />
                  </div>
                </div>
                <div className="mt-3"><button className="px-3 py-2 rounded-xl bg-gray-900 text-white" onClick={buildNOI}>Rebuild NOI</button></div>
                <div className="text-sm mt-3">EGI est.: <b>{currency(monthlyRent*12*(1+otherIncomePct/100))}</b> · OpEx est.: <b>{currency(opxPerUnit*units)}</b> · NOI est.: <b>{currency(noi)}</b></div>
              </SectionCard>

              <SectionCard title="P&L (Annual Chart)">
                <div style={{width:'100%', height: 280}}>
                  <ResponsiveContainer>
                    <BarChart data={[
                      { k: 'Rent+Other', v: monthlyRent*12*(1+otherIncomePct/100) },
                      { k: 'OpEx', v: opxPerUnit*units },
                      { k: 'DebtSvc', v: annualDebtService },
                      { k: 'NOI', v: noi },
                    ]}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="k" />
                      <YAxis />
                      <Tooltip formatter={(value) => currency(Number(value))} />
                      <Legend />
                      <Bar dataKey="v" name="Amount" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </SectionCard>
            </div>
          )}

          {/* Napkin */}
          {tab==='napkin' && (
            <div className="grid md:grid-cols-2 gap-4">
              <SectionCard title="Napkin Assumptions">
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="text-sm">Vacancy/Credit Loss %</label>
                    <input id="vacancy" className="w-full mt-1 border rounded px-2 py-1" defaultValue={5} />
                  </div>
                  <div>
                    <label className="text-sm">Management %</label>
                    <input id="mgmt" className="w-full mt-1 border rounded px-2 py-1" defaultValue={3} />
                  </div>
                  <div>
                    <label className="text-sm">Taxes & Insurance ($/unit/yr)</label>
                    <input id="ti" className="w-full mt-1 border rounded px-2 py-1" defaultValue={2500} />
                  </div>
                  <div>
                    <label className="text-sm">Utilities ($/unit/yr)</label>
                    <input id="utils" className="w-full mt-1 border rounded px-2 py-1" defaultValue={1200} />
                  </div>
                </div>
                <div className="mt-3">
                  <button className="px-3 py-2 rounded-xl bg-gray-900 text-white" onClick={() => {
                    const v = num(document.getElementById('vacancy').value, 5);
                    const m = num(document.getElementById('mgmt').value, 3);
                    const ti = num(document.getElementById('ti').value, 2500);
                    const u = num(document.getElementById('utils').value, 1200);
                    const egi = monthlyRent*12*(1 - v/100) * (1 + otherIncomePct/100);
                    const perp = ti + u + 800; // rough-in other ops
                    const opx = perp * units + (egi * (m/100));
                    setNoi(Math.max(egi - opx, 0));
                  }}>Build NOI from Napkin</button>
                </div>
              </SectionCard>

              <SectionCard title="Deal Sheet">
                <div className="grid grid-cols-2 gap-y-2 text-sm">
                  <div className="text-gray-600">Price</div><div className="font-medium">{currency(purchasePrice)}</div>
                  <div className="text-gray-600">NOI</div><div className="font-medium">{currency(noi)}</div>
                  <div className="text-gray-600">Cap Rate</div><div className="font-medium">{capRate?capRate.toFixed(2)+'%':'–'}</div>
                  <div className="text-gray-600">DSCR</div><div className="font-medium">{dscr?dscr.toFixed(2):'–'}</div>
                  <div className="text-gray-600">Equity Multiple</div><div className="font-medium">{equityMultiple?equityMultiple.toFixed(2)+'x':'–'}</div>
                  <div className="text-gray-600">EGI (est)</div><div className="font-medium">{currency(monthlyRent*12*(1+otherIncomePct/100))}</div>
                </div>
              </SectionCard>
            </div>
          )}

          {/* P&L */}
          {tab==='pl' && (
            <SectionCard title="Simple P&L (Annual)">
              <div style={{width:'100%', height: 320}}>
                <ResponsiveContainer>
                  <BarChart data={[
                    { k: 'Rent+Other', v: monthlyRent*12*(1+otherIncomePct/100) },
                    { k: 'OpEx', v: opxPerUnit*units },
                    { k: 'DebtSvc', v: annualDebtService },
                    { k: 'NOI', v: noi },
                  ]}>
                    <CartesianGrid strokeDasharray="3 3" />
                    <XAxis dataKey="k" />
                    <YAxis />
                    <Tooltip formatter={(value) => currency(Number(value))} />
                    <Legend />
                    <Bar dataKey="v" name="Amount" />
                  </BarChart>
                </ResponsiveContainer>
              </div>
            </SectionCard>
          )}

          {/* Refi/Exit */}
          {tab==='refi' && (
            <div className="grid md:grid-cols-3 gap-4">
              <SectionCard title="Refi / Exit">
                <div className="grid gap-3">
                  <label className="text-sm">Exit Cap (%)</label>
                  <input className="border rounded px-2 py-1" type="number" value={exitCap} onChange={e=>setExitCap(num(e.target.value))} />

                  <label className="text-sm mt-2">Hold (years)</label>
                  <input className="border rounded px-2 py-1" type="number" value={holdYears} onChange={e=>setHoldYears(num(e.target.value))} />

                  <label className="text-sm mt-2">IO Years</label>
                  <input className="border rounded px-2 py-1" type="number" value={ioYears} onChange={e=>setIoYears(num(e.target.value))} />
                </div>
              </SectionCard>

              <SectionCard title="Debt (for reference)">
                <div className="grid grid-cols-2 gap-3 text-sm">
                  <div className="text-gray-600">LTV</div><div className="font-medium">{ltv}%</div>
                  <div className="text-gray-600">Rate</div><div className="font-medium">{rate}%</div>
                  <div className="text-gray-600">Amort</div><div className="font-medium">{amortYears} yrs</div>
                </div>
              </SectionCard>

              <SectionCard title="Assumption Notes">
                <div className="text-sm text-gray-700 space-y-2">
                  <p>Equity Multiple here is a simplified estimate (no taxes/depr.). Sale costs assumed at 1% of terminal value. Adjust NOI/Exit Cap to test sensitivity.</p>
                  <p>Use the Upload on Dashboard to sum monthly rent from a CSV/XLSX rent roll (expects a column with "Rent").</p>
                </div>
              </SectionCard>
            </div>
          )}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
