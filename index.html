<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grand Monarch — Underwriting Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .progress-bar {
      height: 8px;
      background: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: #10b981;
      transition: width 0.3s ease;
    }
    .tab {
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      background: #f3f4f6;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab.active {
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      font-weight: 500;
    }
    .tab:hover:not(.active) {
      background: #e5e7eb;
    }
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
      padding: 16px;
    }
    .verdict-badge {
      padding: 8px 16px;
      border-radius: 16px;
      color: white;
      font-size: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .verdict-good { background: #10b981; }
    .verdict-borderline { background: #f59e0b; }
    .verdict-bad { background: #ef4444; }
    .input {
      width: 100%;
      margin-top: 4px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 8px;
    }
    .button {
      padding: 8px 16px;
      border-radius: 12px;
      background: #111827;
      color: white;
      border: none;
      cursor: pointer;
    }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    @media (max-width: 768px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-900" style="background: #f9fafb; color: #111827;">
  <div style="max-width: 1280px; margin: 0 auto; padding: 24px;">
    
    <!-- Header -->
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px;">
      <div>
        <h1 style="font-size: 30px; font-weight: 600; margin: 0 0 8px 0;">Grand Monarch — Underwriting</h1>
        <p style="font-size: 14px; color: #6b7280; margin: 0;">Prefilled from Synthesis & CoStar comps (OpEx overridden to $340K). Adjust debt terms to see instant verdict.</p>
      </div>
      <div id="verdict-badge" class="verdict-badge verdict-bad">BAD</div>
    </div>

    <!-- Tabs -->
    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px;">
      <button class="tab active" onclick="showTab('dashboard')">Dashboard</button>
      <button class="tab" onclick="showTab('acquisition')">Acquisition</button>
      <button class="tab" onclick="showTab('unitmix')">Unit Mix</button>
      <button class="tab" onclick="showTab('napkin')">Napkin</button>
      <button class="tab" onclick="showTab('exit')">Exit</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard-tab" class="tab-content">
      <div class="grid-3">
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="font-weight: 600;">Cap Rate</div>
            <div style="font-size: 12px; color: #6b7280;">Target ≥ <span id="target-cap">6.3</span>%</div>
          </div>
          <div id="cap-rate-display" style="font-size: 30px; font-weight: 600;">6.25%</div>
          <div class="progress-bar" style="margin-top: 12px;">
            <div id="cap-rate-progress" class="progress-fill" style="width: 99%;"></div>
          </div>
        </div>

        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="font-weight: 600;">DSCR</div>
            <div style="font-size: 12px; color: #6b7280;">Target ≥ 1.25</div>
          </div>
          <div id="dscr-display" style="font-size: 30px; font-weight: 600;">1.42</div>
          <div class="progress-bar" style="margin-top: 12px;">
            <div id="dscr-progress" class="progress-fill" style="width: 100%;"></div>
          </div>
        </div>

        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <div style="font-weight: 600;">Equity Multiple</div>
            <div style="font-size: 12px; color: #6b7280;">Target ≥ 2.00x</div>
          </div>
          <div id="equity-multiple-display" style="font-size: 30px; font-weight: 600;">1.85x</div>
          <div class="progress-bar" style="margin-top: 12px;">
            <div id="equity-multiple-progress" class="progress-fill" style="width: 92%;"></div>
          </div>
        </div>

        <div class="card">
          <div style="font-weight: 600; margin-bottom: 12px;">Quick Setup</div>
          <div style="margin-bottom: 12px;">
            <input type="file" id="file-upload" accept=".csv,.xlsx,.xls" onchange="handleFileUpload()" style="width: 100%; margin-bottom: 8px;">
            <div style="font-size: 14px;">Monthly rent: <span id="monthly-rent-display" style="font-weight: 600;">$95,030</span></div>
          </div>
          <div class="grid-3" style="gap: 8px;">
            <div>
              <label style="font-size: 12px;">Other Income %</label>
              <input id="other-income" class="input" type="number" value="0" onchange="calculateMetrics()">
            </div>
            <div>
              <label style="font-size: 12px;">OpEx/Unit/Yr</label>
              <input id="opex-per-unit" class="input" type="number" value="4722" onchange="calculateMetrics()">
            </div>
            <div style="display: flex; align-items: end;">
              <button class="button" onclick="buildNOI()" style="width: 100%; padding: 12px 8px;">Build NOI</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="font-weight: 600; margin-bottom: 12px;">Verdict</div>
          <div id="verdict-card" class="verdict-bad" style="border-radius: 16px; padding: 24px; color: white;">
            <div style="font-size: 30px; font-weight: bold;">BAD</div>
            <div style="opacity: 0.9; margin-top: 8px; font-size: 14px;">Based on Cap Rate vs Market, DSCR, and Equity Multiple.</div>
          </div>
        </div>

        <div class="card">
          <div style="font-weight: 600; margin-bottom: 12px;">Deal Sheet</div>
          <div class="grid-2" style="gap: 4px 16px; font-size: 14px;">
            <div style="color: #6b7280;">Price</div><div id="price-display" style="font-weight: 500;">$6,000,000</div>
            <div style="color: #6b7280;">NOI</div><div id="noi-display" style="font-weight: 500;">$375,000</div>
            <div style="color: #6b7280;">Cap Rate</div><div id="cap-rate-sheet" style="font-weight: 500;">6.25%</div>
            <div style="color: #6b7280;">DSCR</div><div id="dscr-sheet" style="font-weight: 500;">1.42</div>
            <div style="color: #6b7280;">Equity Multiple</div><div id="equity-sheet" style="font-weight: 500;">1.85x</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Acquisition Tab -->
    <div id="acquisition-tab" class="tab-content" style="display: none;">
      <div class="grid-3">
        <div class="card">
          <div style="font-weight: 600; margin-bottom: 16px;">Acquisition Inputs</div>
          <div>
            <label style="font-size: 14px; font-weight: 500;">Purchase Price</label>
            <input id="purchase-price" class="input" type="number" value="6000000" onchange="calculateMetrics()">
          </div>
          <div style="margin-top: 16px;">
            <label style="font-size: 14px; font-weight: 500;">Market Cap Rate Target (%)</label>
            <input id="market-cap" class="input" type="number" value="6.3" step="0.1" onchange="calculateMetrics()">
          </div>
          <div style="margin-top: 16px;">
            <label style="font-size: 14px; font-weight: 500;">NOI (Annual)</label>
            <input id="noi-input" class="input" type="number" value="375000" onchange="calculateMetrics()">
          </div>
        </div>

        <div class="card">
          <div style="font-weight: 600; margin-bottom: 16px;">Debt</div>
          <div>
            <label style="font-size: 14px; font-weight: 500;">LTV (%)</label>
            <input id="ltv-range" type="range" min="70" max="90" value="70" onchange="updateLTV()" style="width: 100%; margin: 8px 0;">
            <div style="font-size: 14px;">Current LTV: <span id="ltv-display" style="font-weight: 600;">70%</span></div>
          </div>
          <div style="margin-top: 16px;">
            <label style="font-size: 14px; font-weight: 500;">Interest Rate (%)</label>
            <input id="interest-rate" class="input" type="number" value="6.75" step="0.01" onchange="calculateMetrics()">
          </div>
          <div style="margin-top: 16px;">
            <label style="font-size: 14px; font-weight: 500;">Amortization (years)</label>
            <input id="amort-years" class="input" type="number" value="30" onchange="calculateMetrics()">
          </div>
          <div style="margin-top: 16px;">
            <label style="font-size: 14px; font-weight: 500;">IO Period (years)</label>
            <input id="io-years" class="input" type="number" value="0" onchange="calculateMetrics()">
          </div>
        </div>

        <div class="card">
          <div style="font-weight: 600; margin-bottom: 16px;">Closing & Reserves</div>
          <div>
            <label style="font-size: 14px; font-weight: 500;">Closing Costs ($)</label>
            <input id="closing-costs" class="input" type="number" value="0" onchange="calculateMetrics()">
          </div>
          <div style="margin-top: 16px;">
            <label style="font-size: 14px; font-weight: 500;">CapEx ($)</label>
            <input id="capex" class="input" type="number" value="0" onchange="calculateMetrics()">
          </div>
          <div style="margin-top: 16px;">
            <label style="font-size: 14px; font-weight: 500;">Reserves ($)</label>
            <input id="reserves" class="input" type="number" value="142549" onchange="calculateMetrics()">
          </div>
          <div style="margin-top: 16px;">
            <label style="font-size: 14px; font-weight: 500;">Hold (years)</label>
            <input id="hold-years" class="input" type="number" value="5" onchange="calculateMetrics()">
          </div>
          <div style="margin-top: 16px;">
            <label style="font-size: 14px; font-weight: 500;">Exit Cap (%)</label>
            <input id="exit-cap" class="input" type="number" value="6.0" step="0.1" onchange="calculateMetrics()">
          </div>
        </div>
      </div>
    </div>

    <!-- Unit Mix Tab -->
    <div id="unitmix-tab" class="tab-content" style="display: none;">
      <div class="grid-2">
        <div class="card">
          <div style="font-weight: 600; margin-bottom: 16px;">Unit Mix & Income</div>
          <div class="grid-2" style="gap: 12px;">
            <div>
              <label style="font-size: 14px; font-weight: 500;">Total Units</label>
              <input id="total-units" class="input" type="number" value="72" onchange="calculateMetrics()">
            </div>
            <div>
              <label style="font-size: 14px; font-weight: 500;">Monthly Rent (total)</label>
              <input id="monthly-rent" class="input" type="number" value="95030" onchange="calculateMetrics()">
            </div>
          </div>
          <div style="margin-top: 16px;">
            <button class="button" onclick="buildNOI()">Rebuild NOI</button>
          </div>
          <div style="font-size: 14px; margin-top: 12px;">
            EGI est.: <b id="egi-est">$1,140,360</b> · OpEx est.: <b id="opex-est">$340,000</b> · NOI est.: <b id="noi-est">$800,360</b>
          </div>
        </div>

        <div class="card">
          <div style="font-weight: 600; margin-bottom: 16px;">Simple P&L Chart</div>
          <div style="color: #6b7280; text-align: center; padding: 40px; font-style: italic;">
            Chart would display here<br>
            (Rent: <span id="chart-rent">$1,140,360</span>, OpEx: <span id="chart-opex">$340,000</span>, NOI: <span id="chart-noi">$375,000</span>)
          </div>
        </div>
      </div>
    </div>

    <!-- Napkin Tab -->
    <div id="napkin-tab" class="tab-content" style="display: none;">
      <div class="grid-2">
        <div class="card">
          <div style="font-weight: 600; margin-bottom: 16px;">Napkin Assumptions</div>
          <div class="grid-2" style="gap: 12px;">
            <div>
              <label style="font-size: 14px; font-weight: 500;">Vacancy/Credit Loss %</label>
              <input id="vacancy" class="input" type="number" value="5">
            </div>
            <div>
              <label style="font-size: 14px; font-weight: 500;">Management %</label>
              <input id="management" class="input" type="number" value="3">
            </div>
            <div>
              <label style="font-size: 14px; font-weight: 500;">Taxes & Insurance ($/unit/yr)</label>
              <input id="taxes-insurance" class="input" type="number" value="2500">
            </div>
            <div>
              <label style="font-size: 14px; font-weight: 500;">Utilities ($/unit/yr)</label>
              <input id="utilities" class="input" type="number" value="1200">
            </div>
          </div>
          <div style="margin-top: 16px;">
            <button class="button" onclick="buildNapkinNOI()">Build NOI from Napkin</button>
          </div>
        </div>

        <div class="card">
          <div style="font-weight: 600; margin-bottom: 16px;">Deal Summary</div>
          <div class="grid-2" style="gap: 8px 16px; font-size: 14px;">
            <div style="color: #6b7280;">Price</div><div style="font-weight: 500;">$6,000,000</div>
            <div style="color: #6b7280;">NOI</div><div style="font-weight: 500;">$375,000</div>
            <div style="color: #6b7280;">Cap Rate</div><div style="font-weight: 500;">6.25%</div>
            <div style="color: #6b7280;">DSCR</div><div style="font-weight: 500;">1.42</div>
            <div style="color: #6b7280;">Equity Multiple</div><div style="font-weight: 500;">1.85x</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Exit Tab -->
    <div id="exit-tab" class="tab-content" style="display: none;">
      <div class="grid-3">
        <div class="card">
          <div style="font-weight: 600; margin-bottom: 16px;">Exit Assumptions</div>
          <div>
            <label style="font-size: 14px; font-weight: 500;">Exit Cap (%)</label>
            <input id="exit-cap-input" class="input" type="number" value="6.0" step="0.1" onchange="calculateMetrics()">
          </div>
          <div style="margin-top: 16px;">
            <label style="font-size: 14px; font-weight: 500;">Hold (years)</label>
            <input id="hold-years-input" class="input" type="number" value="5" onchange="calculateMetrics()">
          </div>
        </div>

        <div class="card">
          <div style="font-weight: 600; margin-bottom: 16px;">Current Debt Terms</div>
          <div class="grid-2" style="gap: 8px 16px; font-size: 14px;">
            <div style="color: #6b7280;">LTV</div><div style="font-weight: 500;">70%</div>
            <div style="color: #6b7280;">Rate</div><div style="font-weight: 500;">6.75%</div>
            <div style="color: #6b7280;">Amort</div><div style="font-weight: 500;">30 yrs</div>
          </div>
        </div>

        <div class="card">
          <div style="font-weight: 600; margin-bottom: 16px;">Notes</div>
          <div style="font-size: 14px; color: #6b7280; line-height: 1.5;">
            Equity Multiple is a simplified estimate (no taxes/depreciation). Sale costs assumed at 1% of terminal value. 
            Adjust NOI/Exit Cap to test sensitivity.
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // State variables
    let state = {
      purchasePrice: 6000000,
      marketCap: 6.3,
      units: 72,
      monthlyRent: 95030,
      otherIncomePct: 0,
      opxPerUnit: 4722,
      noi: 375000,
      ltv: 70,
      rate: 6.75,
      amortYears: 30,
      ioYears: 0,
      holdYears: 5,
      exitCap: 6.0,
      capex: 0,
      closingCosts: 0,
      reserves: 142549
    };

    // Helper functions
    function num(n, d = 0) {
      if (n === null || n === undefined) return d;
      const x = typeof n === 'string' ? n.replace(/[$,%\s,]/g, '') : n;
      const v = Number(x);
      return Number.isFinite(v) ? v : d;
    }

    function currency(n) {
      return new Intl.NumberFormat(undefined, { 
        style: 'currency', 
        currency: 'USD', 
        maximumFractionDigits: 0 
      }).format(n || 0);
    }

    // Tab switching
    function showTab(tabName) {
      // Hide all tabs
      const tabs = document.querySelectorAll('.tab-content');
      tabs.forEach(tab => tab.style.display = 'none');
      
      // Remove active class from all tab buttons
      const buttons = document.querySelectorAll('.tab');
      buttons.forEach(btn => btn.classList.remove('active'));
      
      // Show selected tab
      document.getElementById(tabName + '-tab').style.display = 'block';
      
      // Add active class to clicked button
      event.target.classList.add('active');
    }

    // LTV slider update
    function updateLTV() {
      const ltv = document.getElementById('ltv-range').value;
      document.getElementById('ltv-display').textContent = ltv + '%';
      state.ltv = num(ltv);
      calculateMetrics();
    }

    // File upload handler
    function handleFileUpload() {
      const fileInput = document.getElementById('file-upload');
      const file = fileInput.files[0];
      if (!file) return;

      const ext = file.name.split('.').pop().toLowerCase();
      
      if (ext === 'csv') {
        const reader = new FileReader();
        reader.onload = function(e) {
          const text = e.target.result;
          const rows = text.split(/\r?\n/).map(r => r.split(','));
          if (!rows.length) return;
          
          const header = rows[0];
          const rentIdx = header.findIndex(h => /rent/i.test(h));
          
          if (rentIdx !== -1) {
            const total = rows.slice(1).reduce((acc, row) => {
              return acc + num(row[rentIdx], 0);
            }, 0);
            
            state.monthlyRent = total;
            document.getElementById('monthly-rent').value = total;
            document.getElementById('monthly-rent-display').textContent = currency(total);
            calculateMetrics();
          }
        };
        reader.readAsText(file);
      }
    }

    // Build NOI
    function buildNOI() {
      const EGI = state.monthlyRent * 12 * (1 + (state.otherIncomePct/100));
      const opx = state.opxPerUnit * state.units;
      state.noi = Math.max(EGI - opx, 0);
      
      document.getElementById('noi-input').value = state.noi;
      calculateMetrics();
    }

    // Build Napkin NOI
    function buildNapkinNOI() {
      const vacancy = num(document.getElementById('vacancy').value, 5);
      const management = num(document.getElementById('management').value, 3);
      const taxesInsurance = num(document.getElementById('taxes-insurance').value, 2500);
      const utilities = num(document.getElementById('utilities').value, 1200);
      
      const egi = state.monthlyRent * 12 * (1 - vacancy/100) * (1 + state.otherIncomePct/100);
      const perUnitOpx = taxesInsurance + utilities + 800; // rough other ops
      const opx = perUnitOpx * state.units + (egi * (management/100));
      
      state.noi = Math.max(egi - opx, 0);
      document.getElementById('noi-input').value = state.noi;
      calculateMetrics();
    }

    // Calculate all metrics
    function calculateMetrics() {
      // Get current values from inputs
      state.purchasePrice = num(document.getElementById('purchase-price').value);
      state.marketCap = num(document.getElementById('market-cap').value);
      state.noi = num(document.getElementById('noi-input').value);
      state.ltv = num(document.getElementById('ltv-range').value);
      state.rate = num(document.getElementById('interest-rate').value);
      state.amortYears = num(document.getElementById('amort-years').value);
      state.ioYears = num(document.getElementById('io-years').value);
      state.holdYears = num(document.getElementById('hold-years').value);
      state.exitCap = num(document.getElementById('exit-cap').value);
      state.capex = num(document.getElementById('capex').value);
      state.closingCosts = num(document.getElementById('closing-costs').value);
      state.reserves = num(document.getElementById('reserves').value);
      state.units = num(document.getElementById('total-units').value);
      state.monthlyRent = num(document.getElementById('monthly-rent').value);
      state.otherIncomePct = num(document.getElementById('other-income').value);
      state.opxPerUnit = num(document.getElementById('opex-per-unit').value);

      // Calculate annual debt service
      const loan = state.purchasePrice * (state.ltv/100);
      const r = state.rate/100/12;
      const n = state.amortYears * 12;
      const monthlyPmt = r === 0 ? loan/n : (loan*r) / (1 - Math.pow(1+r, -n));
      const annualDebtService = monthlyPmt * 12;

      // Calculate metrics
      const capRate = state.purchasePrice ? (state.noi / state.purchasePrice) * 100 : 0;
      const dscr = annualDebtService ? (state.noi / annualDebtService) : 0;
      
      // Simplified equity multiple calculation
      const equity = state.purchasePrice * (1 - state.ltv/100) + state.capex + state.closingCosts + state.reserves;
      const annualCashFlow = Math.max(state.noi - annualDebtService, 0);
      const cumDistributions = annualCashFlow * state.holdYears;
      
      const terminalValue = state.noi / (state.exitCap/100);
      const saleCosts = terminalValue * 0.01;
      const remainingLoan = loan * 0.8; // simplified
      const netSale = Math.max(terminalValue - saleCosts - remainingLoan, 0);
      const totalReturns = cumDistributions + netSale;
      const equityMultiple = equity > 0 ? totalReturns / equity : 0;

      // Score the deal
      let score = 0;
      if (capRate >= state.marketCap) score += 1;
      else if (capRate >= state.marketCap * 0.9) score += 0.5;
      
      if (dscr >= 1.25) score += 1;
      else if (dscr >= 1.15) score += 0.5;
      
      if (equityMultiple >= 2.0) score += 1;
      else if (equityMultiple >= 1.7) score += 0.5;

      let verdict, verdictClass;
      if (score >= 2.5) {
        verdict = 'GOOD';
        verdictClass = 'verdict-good';
      } else if (score >= 1.5) {
        verdict = 'BORDERLINE';
        verdictClass = 'verdict-borderline';
      } else {
        verdict = 'BAD';
        verdictClass = 'verdict-bad';
      }

      // Update display
      update
